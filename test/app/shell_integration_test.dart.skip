import 'package:bloc_test/bloc_test.dart';
import 'package:ditonton/app/shell.dart';
import 'package:ditonton/app/theme_mode_notifier.dart';
import 'package:ditonton_core/core/core.dart';
import 'package:ditonton_movies/features/movies/presentation/pages/home_movie_page.dart';
import 'package:ditonton_movies/features/movies/presentation/providers/movie_list_notifier.dart';
import 'package:ditonton_tv/features/tv/presentation/bloc/airing_today_tv_bloc.dart';
import 'package:ditonton_tv/features/tv/presentation/bloc/on_the_air_tv_bloc.dart';
import 'package:ditonton_tv/features/tv/presentation/bloc/popular_tv_bloc.dart';
import 'package:ditonton_tv/features/tv/presentation/bloc/top_rated_tv_bloc.dart';
import 'package:ditonton_tv/features/tv/presentation/pages/home_tv_page.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:mocktail/mocktail.dart';
import 'package:provider/provider.dart';

// Mocks
class MockThemeModeNotifier extends Mock implements ThemeModeNotifier {}

class MockMovieListNotifier extends Mock implements MovieListNotifier {}

class MockOnTheAirTvBloc extends MockBloc<OnTheAirTvEvent, OnTheAirTvState>
    implements OnTheAirTvBloc {}

class MockAiringTodayTvBloc
    extends MockBloc<AiringTodayTvEvent, AiringTodayTvState>
    implements AiringTodayTvBloc {}

class MockPopularTvBloc extends MockBloc<PopularTvEvent, PopularTvState>
    implements PopularTvBloc {}

class MockTopRatedTvBloc extends MockBloc<TopRatedTvEvent, TopRatedTvState>
    implements TopRatedTvBloc {}

void main() {
  late MockThemeModeNotifier mockThemeModeNotifier;
  late MockMovieListNotifier mockMovieListNotifier;
  late MockOnTheAirTvBloc mockOnTheAirTvBloc;
  late MockAiringTodayTvBloc mockAiringTodayTvBloc;
  late MockPopularTvBloc mockPopularTvBloc;
  late MockTopRatedTvBloc mockTopRatedTvBloc;

  setUp(() {
    mockThemeModeNotifier = MockThemeModeNotifier();
    mockMovieListNotifier = MockMovieListNotifier();
    mockOnTheAirTvBloc = MockOnTheAirTvBloc();
    mockAiringTodayTvBloc = MockAiringTodayTvBloc();
    mockPopularTvBloc = MockPopularTvBloc();
    mockTopRatedTvBloc = MockTopRatedTvBloc();

    // Setup ThemeModeNotifier
    when(() => mockThemeModeNotifier.themeMode).thenReturn(ThemeMode.light);

    // Setup MovieListNotifier
    when(
      () => mockMovieListNotifier.nowPlayingState,
    ).thenReturn(RequestState.Loaded);
    when(() => mockMovieListNotifier.nowPlayingMovies).thenReturn([]);
    when(
      () => mockMovieListNotifier.popularMoviesState,
    ).thenReturn(RequestState.Loaded);
    when(() => mockMovieListNotifier.popularMovies).thenReturn([]);
    when(
      () => mockMovieListNotifier.topRatedMoviesState,
    ).thenReturn(RequestState.Loaded);
    when(() => mockMovieListNotifier.topRatedMovies).thenReturn([]);
    when(
      () => mockMovieListNotifier.fetchNowPlayingMovies(),
    ).thenAnswer((_) async {});
    when(
      () => mockMovieListNotifier.fetchPopularMovies(),
    ).thenAnswer((_) async {});
    when(
      () => mockMovieListNotifier.fetchTopRatedMovies(),
    ).thenAnswer((_) async {});

    // Setup TV BLoCs
    when(() => mockOnTheAirTvBloc.state).thenReturn(OnTheAirTvLoaded([]));
    when(() => mockAiringTodayTvBloc.state).thenReturn(AiringTodayTvLoaded([]));
    when(() => mockPopularTvBloc.state).thenReturn(PopularTvLoaded([]));
    when(() => mockTopRatedTvBloc.state).thenReturn(TopRatedTvLoaded([]));
  });

  tearDown(() {
    // Ensure proper cleanup between tests to avoid widget tree conflicts
    TestWidgetsFlutterBinding.ensureInitialized();
  });

  Widget makeTestableWidget() {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider<ThemeModeNotifier>.value(
          value: mockThemeModeNotifier,
        ),
        ChangeNotifierProvider<MovieListNotifier>.value(
          value: mockMovieListNotifier,
        ),
      ],
      child: MultiBlocProvider(
        providers: [
          BlocProvider<OnTheAirTvBloc>.value(value: mockOnTheAirTvBloc),
          BlocProvider<AiringTodayTvBloc>.value(value: mockAiringTodayTvBloc),
          BlocProvider<PopularTvBloc>.value(value: mockPopularTvBloc),
          BlocProvider<TopRatedTvBloc>.value(value: mockTopRatedTvBloc),
        ],
        child: const MaterialApp(home: AppShell()),
      ),
    );
  }

  testWidgets('AppShell should display Movies page by default', (tester) async {
    await tester.pumpWidget(makeTestableWidget());
    await tester.pumpAndSettle();

    expect(find.byType(HomeMoviePage), findsOneWidget);
    expect(find.byType(HomeTvPage), findsNothing);
  });

  testWidgets('AppShell should navigate to TV page', (tester) async {
    await tester.pumpWidget(makeTestableWidget());
    await tester.pumpAndSettle();

    await tester.tap(find.text('TV'));
    await tester.pumpAndSettle();

    expect(find.byType(HomeTvPage), findsOneWidget);
    expect(find.byType(HomeMoviePage), findsNothing);
  });

  testWidgets('AppShell should navigate to About page', (tester) async {
    await tester.pumpWidget(makeTestableWidget());
    await tester.pumpAndSettle();

    await tester.tap(find.text('About'));
    await tester.pumpAndSettle();

    expect(find.text('About'), findsWidgets); // About page title or content
  });

  testWidgets('AppShell should toggle theme when FAB is tapped', (
    tester,
  ) async {
    await tester.pumpWidget(makeTestableWidget());
    await tester.pumpAndSettle();

    await tester.tap(find.byType(FloatingActionButton));
    await tester.pump();

    verify(() => mockThemeModeNotifier.toggle()).called(1);
  });
}
